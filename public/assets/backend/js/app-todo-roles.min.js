$(function () {
    "use strict";
    var d, n, l, c, r;

    if (0 < $(".todo-application .sidebar-menu-list").length)
        new PerfectScrollbar(".sidebar-menu-list", { theme: "dark" });
    if (0 < $(".todo-application .todo-task-list").length)
        new PerfectScrollbar(".todo-task-list", { theme: "dark" });
    $(document).on(
        "click",
        ".todo-application .todo-item-info i",
        function (o) {
            $(this).parent(".todo-item-info").toggleClass("success"),
                o.stopPropagation();
        }
    ),
        $(document).on(
            "click",
            ".todo-application .todo-item-favorite i",
            function (o) {
                $(this).parent(".todo-item-favorite").toggleClass("warning"),
                    o.stopPropagation();
            }
        ),
        $(".menu-toggle").on("click", function (o) {
            $(".app-content .sidebar-left").removeClass("show"),
                $(".app-content .app-content-overlay").removeClass("show");
        }),
        $(".todo-application .sidebar-close-icon").on("click", function () {
            $(".sidebar-left").removeClass("show"),
                $(".app-content-overlay").removeClass("show");
        }),
        $(".sidebar-toggle").on("click", function (o) {
            o.stopPropagation(),
                $(".app-content .sidebar-left").toggleClass("show"),
                $(".app-content .app-content-overlay").addClass("show");
        }),
        $(".app-content .app-content-overlay").on("click", function (o) {
            $(".app-content .sidebar-left").removeClass("show"),
                $(".app-content .app-content-overlay").removeClass("show");
        }),
        $(".todo-application .list-group-filters a").on("click", function () {
            $(".todo-application .list-group-filters a").hasClass("active") &&
                $(".todo-application .list-group-filters a").removeClass(
                    "active"
                ),
                $(this).addClass("active");
        }),
        992 < $(window).width() &&
            $(".todo-application .app-content-overlay").hasClass("show") &&
            $(".todo-application .app-content-overlay").removeClass("show"),
        $(".add-task button").on("click", function (o) {
            $(".modal .new-todo-item-title").val(""),
                $(".modal .dropdown-menu input").prop("checked", !1),
                $(".modal .todo-item-info").hasClass("success") &&
                    $(".modal .todo-item-info").removeClass("success"),
                $(".modal .todo-item-favorite").hasClass("warning") &&
                    $(".modal .todo-item-favorite").removeClass("warning");
        }),
        $(".add-todo-item").on("click", function (o) {
            o.preventDefault();

            var t = "",
                e = "",
                s = "",
                i = $(".new-todo-item-title").val(),
                permissionIds = [];

            $(".modal.show .todo-item-info").hasClass("success") &&
                (t = " success"),
                $(".modal.show .todo-item-favorite").hasClass("warning") &&
                    (e = " warning"),
                $(".permissionId:checked").each(function () {
                    permissionIds.push($(this).val());
                });

            $.ajax({
                type: "post",
                url: "/role",
                data: { name: i, permissionIds },
                success: function (res) {
                    $('.modal').modal('hide');
                    toastr.success("Role has been created");
                    $(".modal.show .todo-item-info").hasClass("success") &&
                        (t = " success"),
                        $(".modal.show .todo-item-favorite").hasClass(
                            "warning"
                        ) && (e = " warning"),
                        $(".permissionId:checked").each(function () {
                            s +=
                                '<div class="chip mb-0"><div class="chip-body"><span class="chip-text" data-value="' +
                                $(this).data("value") +
                                '"><span class="bullet bullet-' +
                                'primary' +
                                ' bullet-xs"></span> ' +
                                $(this).data("value") +
                                "</span></div></div>";
                        }),
                        "" != i &&
                            $(".todo-task-list-wrapper").append(
                                '<li class="todo-item" style="animation-delay: 0s;"  data-toggle="modal" data-target="#editTaskModal"><div class="todo-title-wrapper d-flex justify-content-between mb-50"><div class="todo-title-area d-flex align-items-center"><div class="title-wrapper d-flex"><div class="vs-checkbox-con"><input type="checkbox" class="roleId" value="' +
                                    res.roleId +
                                    '"><span class="vs-checkbox vs-checkbox-sm"><span class="vs-checkbox--check"><i class="vs-icon feather icon-check"></i></span></span></div><h6 class="todo-title mt-50 mx-50">' +
                                    i +
                                    '</h6></div><div class="chip-wrapper">' +
                                    s +
                                    '</div></div><div class="float-right todo-item-action d-flex"><a class="todo-item-info' +
                                    t +
                                    '"><i class="feather icon-info"></i></a><a class="todo-item-favorite' +
                                    e +
                                    '"><i class="feather icon-star"></i></a><a class="todo-item-delete" data-value="' +
                                    res.roleId +
                                    '"><i class="feather icon-trash"></i></a></div></div></li>'
                            );
                },
                error: function (err) {
                    $('.none-title') && $('.none-title').remove();
                    $('.new-todo-item-title').after(`<span class="text-danger none-title">${err.responseJSON.errors.name}</span>`);
                },
            }),
                $("#form-edit-todo .edit-todo-item-title").val(i),
                $("#form-edit-todo .dropdown-menu input").prop("checked", !1),
                $("#form-edit-todo .edit-todo-item-info").hasClass("success") &&
                    $("#form-edit-todo .edit-todo-item-info").addClass(
                        "success"
                    ),
                $("#form-edit-todo .edit-todo-item-favorite").hasClass(
                    "warning"
                ) &&
                    $("#form-edit-todo .edit-todo-item-favorite").addClass(
                        "warning"
                    );
        }),
        $(document).on(
            "click",
            ".todo-task-list-wrapper .todo-item",
            function (o) {
                (d = $(this).find(".todo-title")),
                    (id = $(this).find(".roleId")),
                    (l = $(this).find(".todo-item-info")),
                    (c = $(this).find(".todo-item-favorite")),
                    (r = $(this).find(".chip-wrapper"));
                var t = $(this).find(".todo-title").html(),
                    s = $(this).find(".todo-item-info"),
                    i = $(this).find(".todo-item-favorite"),
                    id = $(this).find(".roleId").val();

                $("#form-edit-todo .vs-checkbox-con input").prop("checked", !1),
                    $(this)
                        .find(".chip")
                        .each(function () {
                            var o = $(this).find(".chip-text").data("value");
                            $(
                                '#form-edit-todo .vs-checkbox-con input[data-value="' +
                                    o +
                                    '"]'
                            ).prop("checked", !0);
                        }),
                    $("#form-edit-todo .edit-todo-item-title").val(t),
                    $("#form-edit-todo .roleId").val(id),
                    $("#form-edit-todo .todo-item-info").hasClass("success") &&
                        $("#form-edit-todo .todo-item-info").removeClass(
                            "success"
                        ),
                    $("#form-edit-todo .edit-todo-item-favorite").hasClass(
                        "warning"
                    ) &&
                        $(
                            "#form-edit-todo .edit-todo-item-favorite"
                        ).removeClass("warning"),
                    $(s).hasClass("success") &&
                        $("#form-edit-todo .todo-item-info").addClass(
                            "success"
                        ),
                    $(i).hasClass("warning") &&
                        $("#form-edit-todo .edit-todo-item-favorite").addClass(
                            "warning"
                        );
            }
        ),
        $(".update-todo-item").on("click", function () {
            var o = $("#form-edit-todo .edit-todo-item-title").val(),
                e = $("#form-edit-todo .todo-item-info i"),
                s = $("#form-edit-todo .todo-item-favorite i"),
                id = $("#form-edit-todo .roleId").val(),
                permissionIds = [];
            $(l).hasClass("success") && $(l).removeClass("success"),
                $(c).hasClass("warning") && $(c).removeClass("warning"),
                $(e).parent(".todo-item-info").hasClass("success") &&
                    l.addClass("success"),
                $(s).parent(".todo-item-favorite").hasClass("warning") &&
                    c.addClass("warning");
            var i = $(".permissionIdUpdate:checked"),
                a = "";
                console.log(i.length);
            console.log(permissionIds.length);
            i.each(function () {

                permissionIds.push($(this).val());
                a +=
                    '<div class="chip mb-0"><div class="chip-body"><span class="chip-text" data-value="' +
                    $(this).data("value") +
                    '"><span class="bullet bullet-' +
                    'primary' +
                    ' bullet-xs"></span> ' +
                    $(this).data("value") +
                    "</span></div></div>";
            }),
                $.ajax({
                    type: "patch",
                    url: `/role/${id}`,
                    data: { name: o, permissionIds },
                    success: function (res) {
                        $('.modal').modal('hide');
                        $(d).text(o), r.empty(), $(r).append(a);
                        toastr.info("Role has been updated");
                    },
                    error: function (err) {

                        $('.none-title') && $('.none-title').remove();
                        if(err.status == 405) {
                            $('.edit-todo-item-title').after(`<span class="text-danger none-title">عنوان قبلا انتخاب شده است!</span>`);

                        } else {

                            $('.edit-todo-item-title').after(`<span class="text-danger none-title">${err.responseJSON.errors.name}</span>`);
                        }
                    },
                });
        }),
        $(document).on("click", ".todo-item-delete", function (o) {
            var id = $(this).data("value"),
                that = $(this);
            o.stopPropagation();
            $.ajax({
                type: "delete",
                url: `/role/${id}`,
                success: function (res) {
                    toastr.warning("Role has been deleted!");

                    console.log(res);
                    that.closest(".todo-item").remove();
                },
                error: function (err) {
                    console.log(err);
                },
            });
        }),
        $(document).on("click", ".todo-item input", function (o) {
            o.stopPropagation(),
                $(this).closest(".todo-item").toggleClass("completed");
        }),
        $("#todo-search").on("keyup", function () {
            var o = $(this).val().toLowerCase();
            "" != o
                ? ($(".todo-item").filter(function () {
                      $(this).toggle(
                          -1 < $(this).text().toLowerCase().indexOf(o)
                      );
                  }),
                  0 == $(".todo-item:visible").length
                      ? $(".no-results").hasClass("show") ||
                        $(".no-results").addClass("show")
                      : $(".no-results").removeClass("show"))
                : ($(".todo-item").show(),
                  $(".no-results").hasClass("show") &&
                      $(".no-results").removeClass("show"));
        });
        $("#permission-search").on("keyup", function () {
            var o = $(this).val().toLowerCase();
            console.log(o);
            "" != o
                ? ($(".title-wrapper").filter(function () {
                      $(this).toggle(
                          -1 < $(this).text().toLowerCase().indexOf(o)
                      );
                  }),
                  0 == $(".title-wrapper:visible").length
                      ? $(".no-results").hasClass("show") ||
                        $(".no-results").addClass("show")
                      : $(".no-results").removeClass("show"))
                : ($(".title-wrapper").show(),
                  $(".no-results").hasClass("show") &&
                      $(".no-results").removeClass("show"));
        });
        $("#permission-update-search").on("keyup", function () {
            var o = $(this).val().toLowerCase();
            console.log(o);
            "" != o
                ? ($(".title-wrapper").filter(function () {
                      $(this).toggle(
                          -1 < $(this).text().toLowerCase().indexOf(o)
                      );
                  }),
                  0 == $(".title-wrapper:visible").length
                      ? $(".no-results").hasClass("show") ||
                        $(".no-results").addClass("show")
                      : $(".no-results").removeClass("show"))
                : ($(".title-wrapper").show(),
                  $(".no-results").hasClass("show") &&
                      $(".no-results").removeClass("show"));
        });
}),
    $(window).on("resize", function () {
        992 < $(window).width() &&
            $(".app-content .app-content-overlay").hasClass("show") &&
            ($(".app-content .sidebar-left").removeClass("show"),
            $(".app-content .app-content-overlay").removeClass("show"));
    });
